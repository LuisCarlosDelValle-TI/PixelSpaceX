<!-- Modal para editar producto -->
<div id="edit-product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" aria-hidden="true">
    <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center p-6 border-b sticky top-0 bg-white z-10">
            <h3 class="text-xl font-bold text-gray-800">
                <i class="fas fa-edit text-blue-500 mr-2"></i>
                Editar Producto
            </h3>
            <button onclick="hideModal('edit-product-modal')" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <form id="edit-product-form" class="p-6">
            <input type="hidden" id="edit-product-id" name="id">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Columna Izquierda -->
                <div class="space-y-4">
                    <!-- Código de Barras -->
                    <div>
                        <label for="edit-barcode" class="block text-sm font-medium text-gray-700 mb-1">
                            Código de Barras
                            <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <input type="text" id="edit-barcode" name="barcode" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="Escanear o ingresar código">
                        </div>
                    </div>

                    <!-- Nombre del Producto -->
                    <div>
                        <label for="edit-name" class="block text-sm font-medium text-gray-700 mb-1">
                            Nombre del Producto
                            <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="edit-name" name="name" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Ej. Cuaderno profesional">
                    </div>

                    <!-- Descripción -->
                    <div>
                        <label for="edit-description" class="block text-sm font-medium text-gray-700 mb-1">
                            Descripción
                        </label>
                        <textarea id="edit-description" name="description" rows="2"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Descripción detallada del producto"></textarea>
                    </div>

                    <!-- Categoría -->
                    <div>
                        <label for="edit-category" class="block text-sm font-medium text-gray-700 mb-1">
                            Categoría
                            <span class="text-red-500">*</span>
                        </label>
                        <select id="edit-category" name="category" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Seleccionar categoría</option>
                            <option value="papeleria">Papelería</option>
                            <option value="escolares">Útiles Escolares</option>
                            <option value="oficina">Oficina</option>
                            <option value="electronica">Electrónica</option>
                            <option value="regalos">Regalos</option>
                        </select>
                    </div>
                </div>

                <!-- Columna Derecha -->
                <div class="space-y-4">
                    <!-- Precio de Venta -->
                    <div>
                        <label for="edit-price" class="block text-sm font-medium text-gray-700 mb-1">
                            Precio de Venta
                            <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500">$</span>
                            </div>
                            <input type="number" id="edit-price" name="price" min="0.01" step="0.01" required
                                   class="pl-8 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="0.00">
                        </div>
                    </div>

                    <!-- Costo -->
                    <div>
                        <label for="edit-cost" class="block text-sm font-medium text-gray-700 mb-1">
                            Costo
                            <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500">$</span>
                            </div>
                            <input type="number" id="edit-cost" name="cost" min="0.01" step="0.01" required
                                   class="pl-8 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="0.00">
                        </div>
                    </div>

                    <!-- Stock -->
                    <div>
                        <label for="edit-stock" class="block text-sm font-medium text-gray-700 mb-1">
                            Stock Actual
                            <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="edit-stock" name="stock" min="0" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Cantidad en inventario">
                    </div>

                    <!-- Stock Mínimo -->
                    <div>
                        <label for="edit-min-stock" class="block text-sm font-medium text-gray-700 mb-1">
                            Stock Mínimo
                            <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="edit-min-stock" name="min_stock" min="0" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Nivel de reorden">
                    </div>

                    <!-- Unidad de Medida -->
                    <div>
                        <label for="edit-unit" class="block text-sm font-medium text-gray-700 mb-1">
                            Unidad de Medida
                            <span class="text-red-500">*</span>
                        </label>
                        <select id="edit-unit" name="unit" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="pz">Pieza (pz)</option>
                            <option value="kg">Kilogramo (kg)</option>
                            <option value="l">Litro (l)</option>
                            <option value="m">Metro (m)</option>
                            <option value="paq">Paquete (paq)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Notas -->
            <div class="mt-6">
                <label for="edit-notes" class="block text-sm font-medium text-gray-700 mb-1">
                    Notas Adicionales
                </label>
                <textarea id="edit-notes" name="notes" rows="2"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          placeholder="Información adicional sobre el producto"></textarea>
            </div>

            <!-- Sección de Estado -->
            <div class="mt-6 pt-6 border-t border-gray-200">
                <div class="flex items-center">
                    <input id="edit-active" name="active" type="checkbox"
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="edit-active" class="ml-2 block text-sm text-gray-700">
                        Producto activo (disponible para venta)
                    </label>
                </div>
            </div>

            <!-- Botones de Acción -->
            <div class="mt-8 flex justify-between">
                <button type="button" onclick="eliminarProducto()"
                        class="px-4 py-2 border border-red-300 rounded-lg text-sm font-medium text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    <i class="fas fa-trash mr-1"></i> Eliminar
                </button>
                <div class="space-x-3">
                    <button type="button" onclick="hideModal('edit-product-modal')"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Cancelar
                    </button>
                    <button type="submit"
                            class="px-6 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-save mr-1"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// Funciones para manejar el modal
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
}

// Función para cargar los datos del producto en el formulario de edición
async function cargarProductoParaEditar(idProducto) {
    try {
        // Mostrar indicador de carga
        const loadingAlert = await Swal.fire({
            title: 'Cargando producto...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // Obtener el ID limpio (sin prefijo PROD- si existe)
        let productId = idProducto;
        if (typeof idProducto === 'string' && idProducto.startsWith('PROD-')) {
            productId = idProducto.replace('PROD-', '');
        }
        
        // Hacer la petición para obtener los datos del producto
        const response = await fetch(`${API_BASE_URL}/productos/${productId}`, {
            ...fetchConfig,
            method: 'GET'
        });

        if (!response.ok) {
            throw new Error('Error al cargar el producto');
        }

        const producto = await response.json();
        
        // Rellenar el formulario con los datos del producto
        document.getElementById('edit-product-id').value = producto.id_producto;
        document.getElementById('edit-barcode').value = producto.codigo_barras || '';
        document.getElementById('edit-name').value = producto.nombre || '';
        document.getElementById('edit-description').value = producto.descripcion || '';
        document.getElementById('edit-category').value = producto.categoria || '';
        document.getElementById('edit-price').value = producto.precio_venta || '';
        document.getElementById('edit-cost').value = producto.costo || '';
        document.getElementById('edit-stock').value = producto.stock || 0;
        document.getElementById('edit-min-stock').value = producto.stock_minimo || 0;
        document.getElementById('edit-unit').value = producto.unidad_medida || 'pz';
        document.getElementById('edit-notes').value = producto.notas || '';
        document.getElementById('edit-active').checked = producto.activo !== 0;
        
        // Mostrar el modal de edición
        showModal('edit-product-modal');
        
    } catch (error) {
        console.error('Error al cargar el producto:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudo cargar el producto. Por favor, inténtalo de nuevo.'
        });
    } finally {
        // Cerrar el indicador de carga
        if (loadingAlert) {
            loadingAlert.close();
        }
    }
}

// Función para manejar el envío del formulario de edición
async function manejarEdicionProducto(e) {
    e.preventDefault();
    
    try {
        const formData = {
            id_producto: document.getElementById('edit-product-id').value,
            codigo_barras: document.getElementById('edit-barcode').value,
            nombre: document.getElementById('edit-name').value,
            descripcion: document.getElementById('edit-description').value,
            categoria: document.getElementById('edit-category').value,
            precio_venta: parseFloat(document.getElementById('edit-price').value),
            costo: parseFloat(document.getElementById('edit-cost').value),
            stock: parseInt(document.getElementById('edit-stock').value, 10),
            stock_minimo: parseInt(document.getElementById('edit-min-stock').value, 10),
            unidad_medida: document.getElementById('edit-unit').value,
            notas: document.getElementById('edit-notes').value,
            activo: document.getElementById('edit-active').checked ? 1 : 0
        };
        
        // Mostrar indicador de carga
        const loadingAlert = await Swal.fire({
            title: 'Actualizando producto...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        // Enviar los datos al servidor
        const response = await fetch(`${API_BASE_URL}/productos/${formData.id_producto}`, {
            ...fetchConfig,
            method: 'PUT',
            body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Error al actualizar el producto');
        }
        
        // Cerrar el modal y mostrar mensaje de éxito
        hideModal('edit-product-modal');
        
        Swal.fire({
            icon: 'success',
            title: '¡Éxito!',
            text: 'El producto se ha actualizado correctamente',
            timer: 2000,
            showConfirmButton: false
        });
        
        // Recargar la lista de productos
        cargarProductos();
        
    } catch (error) {
        console.error('Error al actualizar el producto:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.message || 'No se pudo actualizar el producto. Por favor, inténtalo de nuevo.'
        });
    }
}

// Función para eliminar un producto
async function eliminarProducto() {
    const idProducto = document.getElementById('edit-product-id').value;
    
    const result = await Swal.fire({
        title: '¿Estás seguro?',
        text: 'Esta acción no se puede deshacer y eliminará permanentemente el producto.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    });
    
    if (result.isConfirmed) {
        try {
            // Mostrar indicador de carga
            const loadingAlert = await Swal.fire({
                title: 'Eliminando producto...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Enviar la solicitud de eliminación
            const response = await fetch(`${API_BASE_URL}/productos/${idProducto}`, {
                ...fetchConfig,
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error('Error al eliminar el producto');
            }
            
            // Cerrar el modal y mostrar mensaje de éxito
            hideModal('edit-product-modal');
            
            Swal.fire({
                icon: 'success',
                title: '¡Eliminado!',
                text: 'El producto ha sido eliminado correctamente',
                timer: 2000,
                showConfirmButton: false
            });
            
            // Recargar la lista de productos
            cargarProductos();
            
        } catch (error) {
            console.error('Error al eliminar el producto:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudo eliminar el producto. Por favor, inténtalo de nuevo.'
            });
        }
    }
}

// Inicializar el formulario de edición cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    const editForm = document.getElementById('edit-product-form');
    if (editForm) {
        editForm.addEventListener('submit', manejarEdicionProducto);
    }
});
</script>
